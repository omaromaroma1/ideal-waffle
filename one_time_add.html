<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Money Budgeter — One time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b1426" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <link rel="manifest" href="/manifest.json" />
  <style>
    :root{ --bg:#0b1426; --card:#0f1f3a; --border:#1e335a; --text:#eaf0ff; --muted:#a8b3cf; --accent:#0a6bff; --chip:#142646; --chip-on:#0a6bff; }
    *{box-sizing:border-box} html{-webkit-text-size-adjust:100%}
    body{margin:0;padding-top:env(safe-area-inset-top);background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:rgba(8,16,32,.6);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .container{padding:18px;max-width:680px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="time"]{width:100%;padding:14px 12px;border-radius:12px;border:1px solid var(--border);background:#0c1a33;color:#fff;outline:none;font-size:16px}
    details{background:#0e1c36;border:1px solid var(--border);border-radius:14px;padding:10px 12px;color:#cfd6e6}
    details[open]{background:#10254a}
    summary{list-style:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-weight:600}
    summary::-webkit-details-marker{display:none}
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .chip{padding:10px 12px;border-radius:999px;background:var(--chip);border:1px solid var(--border);cursor:pointer;user-select:none;font-size:14px;color:#cfd6e6}
    .chip.active{background:var(--chip-on);border-color:var(--chip-on);color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{width:100%;padding:14px;border-radius:12px;background:var(--accent);border:none;color:#fff;font-weight:700;font-size:16px;cursor:pointer}
  </style>
</head>
<body>
  <div class="topbar">
    <a href="repeat.html" style="color:#cfd6e6;text-decoration:none">Back</a>
    <div style="font-weight:700">One-time Entry</div>
    <div style="width:40px"></div>
  </div>

  <div class="container">
    <div class="card">
      <div class="row">
        <div>
          <label>Amount</label>
          <input id="amount" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="0.00" autocomplete="off" />
        </div>
        <div>
          <label>Type</label>
          <div class="chips" id="typeChips" role="group" aria-label="Add/Subtract">
            <div class="chip active" data-type="add">Add</div>
            <div class="chip" data-type="subtract">Subtract</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <details id="monthBox">
        <summary>Month (optional) <span>▾</span></summary>
        <div class="chips" id="months">
          <div class="chip" data-month="Jan">Jan</div><div class="chip" data-month="Feb">Feb</div><div class="chip" data-month="Mar">Mar</div>
          <div class="chip" data-month="Apr">Apr</div><div class="chip" data-month="May">May</div><div class="chip" data-month="Jun">Jun</div>
          <div class="chip" data-month="Jul">Jul</div><div class="chip" data-month="Aug">Aug</div><div class="chip" data-month="Sep">Sep</div>
          <div class="chip" data-month="Oct">Oct</div><div class="chip" data-month="Nov">Nov</div><div class="chip" data-month="Dec">Dec</div>
        </div>
      </details>
    </div>

    <div class="card">
      <label>Day of Month (optional)</label>
      <div id="dom" class="chips">
        <div class="chip" data-dom="1">1</div><div class="chip" data-dom="5">5</div><div class="chip" data-dom="10">10</div>
        <div class="chip" data-dom="15">15</div><div class="chip" data-dom="20">20</div><div class="chip" data-dom="25">25</div>
        <div class="chip" data-dom="30">30</div>
      </div>
    </div>

    <div class="card">
      <label>Time (optional)</label>
      <input id="time" type="time" />
    </div>

    <div class="card">
      <button class="btn" id="saveBtn">Save</button>
    </div>
  </div>

  <script>
    const get = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } };
    const set = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
    const qs = new URLSearchParams(location.search);
    const editId = qs.get('edit');

    // Prefill if editing
    if (editId){
      const arr = get('mb:oneTimeEntries', []);
      const it = arr.find(x => x.id === editId);
      if (it){
        document.getElementById('amount').value = it.amount ?? '';
        document.getElementById('time').value = it.time ?? '';
        document.querySelectorAll('#typeChips .chip').forEach(c => c.classList.toggle('active', c.dataset.type === it.type));
        (it.months||[]).forEach(m => { const chip = document.querySelector(`#months .chip[data-month="${m}"]`); if (chip) chip.classList.add('active'); });
        (it.daysOfMonth||[]).forEach(d => { const chip = document.querySelector(`#dom .chip[data-dom="${d}"]`); if (chip) chip.classList.add('active'); });
        // Expand month box if there are months selected
        if ((it.months||[]).length){ document.getElementById('monthBox').setAttribute('open',''); }
      }
    }

    document.getElementById('typeChips').addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      document.querySelectorAll('#typeChips .chip').forEach(x=>x.classList.remove('active'));
      chip.classList.add('active');
    });
    document.addEventListener('click', function(e){
      const chip = e.target.closest('#months .chip, #dom .chip'); if(!chip) return;
      chip.classList.toggle('active');
    });

    document.getElementById('saveBtn').addEventListener('click', ()=>{
      const type = document.querySelector('#typeChips .chip.active')?.dataset.type || 'add';
      const amount = parseFloat((document.getElementById('amount').value||'').replace(',','.')) || 0;
      const months = Array.from(document.querySelectorAll('#months .chip.active')).map(x=>x.dataset.month);
      const dom = Array.from(document.querySelectorAll('#dom .chip.active')).map(x=>x.dataset.dom);
      const time = document.getElementById('time').value || null;

      const key = 'mb:oneTimeEntries';
      const arr = get(key, []);
      if (editId){
        const idx = arr.findIndex(x => x.id === editId);
        if (idx !== -1) arr[idx] = { ...arr[idx], type, amount, months, daysOfMonth: dom, time, updatedAt: new Date().toISOString() };
      } else {
        arr.push({ id: crypto.randomUUID?.() || String(Date.now()), type, amount, months, daysOfMonth: dom, time, createdAt: new Date().toISOString() });
      }
      set(key, arr);
      window.location.href = 'repeat.html';
    });

    document.querySelectorAll('input').forEach(el=>{ el.style.fontSize='16px'; });
  </script>
</body>
</html>
