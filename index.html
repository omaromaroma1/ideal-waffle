// Tracking active camera stream
let currentCameraTrack = null;

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: true, audio: false })
    .then(stream => {
      const video = document.getElementById('camera-stream');
      currentCameraTrack = stream.getTracks()[0];
      video.srcObject = stream;
      video.style.display = 'block';
      document.getElementById('flipCameraBtn').style.display = 'block';
      video.onloadedmetadata = function() {
        video.play(); // Ensure video plays on mobile browsers
      };
    })
    .catch(err => {
      console.error('Failed to access camera:', err);
      alert('Please grant permission to access your camera.');
    });
}

function flipCamera() {
  // Only attempt if stream exists
  if (!currentCameraTrack) return;

  // Stop existing track
  currentCameraTrack.stop();

  // Attempt to start the opposite facing camera
  const oppositeFacingMode = currentCameraTrack.facingMode === 'user' ? 'environment' : 'user';

  navigator.mediaDevices.getUserMedia({ video: { facingMode: oppositeFacingMode }, audio: false })
    .then(stream => {
      const video = document.getElementById('camera-stream');
      video.srcObject = stream;
      video.style.display = 'block';
      currentCameraTrack = stream.getTracks()[0];
      video.onloadedmetadata = function() {
        video.play(); // Ensure video plays on mobile browsers
      };
    })
    .catch(err => {
      console.error('Failed to flip camera:', err);
      alert('Failed to flip camera. Please check that camera permissions are enabled.');
      // Revert to user camera if flip fails
      startCamera();
    });
}

function capturePhoto() {
  const video = document.getElementById('camera-stream');
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const photoUrl = canvas.toDataURL('image/jpeg');
  
  // Store captured photo
  capturedPhoto = photoUrl;
  stopCamera();
}

function stopCamera() {
  if (currentCameraTrack) {
    currentCameraTrack.stop();
    currentCameraTrack = null;
  }

  const video = document.getElementById('camera-stream');
  video.srcObject = null;
  video.style.display = 'none';
}
