<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Money Budgeter</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      transition: background 0.3s, color 0.3s;
      padding: 20px;
    }
    body.light-mode { background: #fff; color: #000; }
    body.dark-mode  { background: #121212; color: #eee; }

    .calculator-box {
      width: 360px; margin: 0 auto; background: #f7f7f7;
      border-radius: 20px; padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    body.dark-mode .calculator-box { background: #1e1e1e; box-shadow: 0 5px 15px rgba(255,255,255,0.05); }

    h1 { text-align: center; margin-bottom: 15px; color: #007bff; }
    #clock, #budget { text-align: center; margin: 8px 0; }

    #renewal-summary, #renewal-today, #renewal-next {
      text-align:center; margin: 6px 0; font-size: 14px;
    }

    .buttons, .numpad {
      display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 15px 0;
    }
    button {
      flex: 1 1 45%; padding: 12px; border: none; border-radius: 12px;
      font-size: 15px; background: #007bff; color: white; font-weight: bold;
      cursor: pointer; transition: background 0.3s;
    }
    button:hover { background: #0056b3; }
    .numpad button { flex: 1 1 30%; padding: 15px; font-size: 18px; background: #444; }

    #history {
      max-height: 220px; overflow-y: auto; background: #fff; border: 1px solid #ccc;
      border-radius: 12px; padding: 10px;
    }
    body.dark-mode #history { background: #2c2c2c; border-color: #666; }

    #mode-toggle { position: fixed; bottom: 20px; right: 20px; font-size: 26px; cursor: pointer; }

    #input-display {
      width: 100%; text-align: right; font-size: 24px; padding: 10px;
      border: none; background: transparent; color: inherit;
    }

    .category-popup, .category-totals {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #fff; padding: 20px; border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 999; max-width: 90%;
    }
    .category-popup h3, .category-totals h3 { margin-bottom: 15px; text-align: center; }
    .category-popup button, .category-totals button {
      width: 100%; margin-bottom: 10px; padding: 10px; border: none;
      border-radius: 8px; font-size: 16px; background: #007bff; color: white;
    }
    .category-popup button:last-child, .category-totals button:last-child { background: #ccc; color: #000; }

    .small { font-size: 12px; opacity: .85; text-align:center; }
  </style>
</head>
<body>
  <div class="calculator-box">
    <h1>Money Budgeter</h1>
    <div id="clock">🕒 Time: --:--</div>
    <div id="budget">Budget: $0</div>

    <div id="renewal-summary" class="small"></div>
    <div id="renewal-today" class="small"></div>
    <div id="renewal-next" class="small"></div>

    <input id="input-display" placeholder="Enter amount" readonly />

    <div class="numpad">
      <button onclick="appendNumber('1')">1</button>
      <button onclick="appendNumber('2')">2</button>
      <button onclick="appendNumber('3')">3</button>
      <button onclick="appendNumber('4')">4</button>
      <button onclick="appendNumber('5')">5</button>
      <button onclick="appendNumber('6')">6</button>
      <button onclick="appendNumber('7')">7</button>
      <button onclick="appendNumber('8')">8</button>
      <button onclick="appendNumber('9')">9</button>
      <button onclick="appendNumber('0')">0</button>
      <button onclick="appendNumber('.')">.</button>
      <button onclick="backspace()">⌫</button>
    </div>

    <div class="buttons">
      <button onclick="submitAmount('add')">Add</button>
      <button onclick="showCategoryPopup()">Subtract</button>
      <button onclick="clearHistory()">Clear History</button>
      <button onclick="resetBudget()">Reset</button>
      <button onclick="location.href='repeat.html'">Repeat ➕</button>
      <button onclick="viewCategoryTotals()">📊 View Categories</button>
      <button onclick="runAutoRenewals(true)">↻ Refresh Renewals</button>
    </div>

    <div id="history"></div>
  </div>

  <div id="mode-toggle" onclick="toggleMode()">🌙</div>
  <div id="category-popup" class="category-popup" style="display:none;"></div>
  <div id="category-totals" class="category-totals" style="display:none;"></div>

  <script>
    // ====== Elements & State ======
    const inputDisplay = document.getElementById('input-display');
    const budgetDisplay = document.getElementById('budget');
    const historyDiv = document.getElementById('history');
    const popup = document.getElementById('category-popup');
    const totalsPopup = document.getElementById('category-totals');
    const renewalSummaryEl = document.getElementById('renewal-summary');
    const renewalTodayEl = document.getElementById('renewal-today');
    const renewalNextEl = document.getElementById('renewal-next');

    let budget = parseFloat(localStorage.getItem('budget')) || 0;
    let history = JSON.parse(localStorage.getItem('history')) || [];
    let appliedMap = JSON.parse(localStorage.getItem('autoRenewalsApplied')) || {}; // {id: 'YYYY-MM-DD'}

    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const weekdayNames = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

    // ====== Clock & Theme ======
    function updateClock() {
      const n = new Date();
      document.getElementById('clock').textContent =
        `🕒 Time: ${n.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:true})}`;
    }
    setInterval(updateClock, 1000); updateClock();

    const savedMode = localStorage.getItem('theme');
    if (savedMode === 'dark') document.body.classList.add('dark-mode'); else document.body.classList.add('light-mode');
    function toggleMode() {
      const isDark = document.body.classList.contains('dark-mode');
      document.body.classList.toggle('dark-mode', !isDark);
      document.body.classList.toggle('light-mode', isDark);
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    // ====== Calculator input ======
    function appendNumber(num){ inputDisplay.value += num; }
    function backspace(){ inputDisplay.value = inputDisplay.value.slice(0,-1); }
    function clearInput(){ inputDisplay.value = ''; }

    function submitAmount(type) {
      const value = parseFloat(inputDisplay.value);
      if (isNaN(value)) return;
      const timestamp = new Date().toLocaleString();
      if (type === 'add') {
        budget += value;
        history.push({ type: 'Add', value, timestamp });
      }
      localStorage.setItem('budget', budget);
      localStorage.setItem('history', JSON.stringify(history));
      updateBudgetDisplay(); renderHistory(); clearInput();
    }

    function showCategoryPopup() {
      popup.innerHTML = `
        <h3>Select Category</h3>
        <button onclick="confirmCategory('Leisure')">Leisure</button>
        <button onclick="confirmCategory('Transportation')">Transportation</button>
        <button onclick="confirmCategory('Food')">Food</button>
        <button onclick="confirmCategory('Groceries')">Groceries</button>
        <button onclick="confirmCategory('Others')">Others</button>
        <button onclick="popup.style.display='none'">Cancel</button>
      `;
      popup.style.display = 'block';
    }

    function confirmCategory(category) {
      const value = parseFloat(inputDisplay.value);
      popup.style.display = 'none';
      clearInput();
      if (isNaN(value)) return;
      const timestamp = new Date().toLocaleString();
      budget -= value;
      history.push({ type: `Subtract (${category})`, value, timestamp });
      localStorage.setItem('budget', budget);
      localStorage.setItem('history', JSON.stringify(history));
      updateBudgetDisplay(); renderHistory();
    }

    function clearHistory() {
      history = [];
      localStorage.setItem('history', JSON.stringify(history));
      renderHistory();
    }

    function resetBudget() {
      budget = 0;
      localStorage.setItem('budget', budget);
      updateBudgetDisplay();
    }

    function updateBudgetDisplay() {
      const currency = localStorage.getItem('currency') || '$';
      budgetDisplay.innerText = `Budget: ${currency}${budget.toFixed(2)}`;
    }

    function renderHistory() {
      historyDiv.innerHTML = '';
      history.slice().reverse().forEach(item => {
        const div = document.createElement('div');
        div.textContent = `${item.timestamp} — ${item.type}: $${item.value.toFixed(2)}`;
        historyDiv.appendChild(div);
      });
    }

    function viewCategoryTotals() {
      const categories = ['Leisure','Transportation','Food','Groceries','Others'];
      const totals = Object.fromEntries(categories.map(c=>[c,0]));
      history.forEach(h=>{
        const m = h.type.match(/^Subtract \((.+)\)$/);
        if (m && totals[m[1]] !== undefined) totals[m[1]] += h.value;
      });
      totalsPopup.innerHTML = '<h3>Category Totals</h3>';
      categories.forEach(cat=>{
        const btn = document.createElement('button');
        btn.disabled = true;
        btn.textContent = `${cat}: $${totals[cat].toFixed(2)}`;
        totalsPopup.appendChild(btn);
      });
      const close = document.createElement('button');
      close.textContent = 'Close';
      close.onclick = ()=> totalsPopup.style.display='none';
      totalsPopup.appendChild(close);
      totalsPopup.style.display = 'block';
    }

    // ====== Auto-Renew logic ======
    function todayISO(d=new Date()){
      return d.toISOString().slice(0,10);
    }
    function hhmm(d=new Date()){
      return d.toTimeString().slice(0,5); // "HH:MM"
    }
    function compareTimeLE(a,b){ return a <= b; } // strings "HH:MM"

    function shouldRunToday(entry, now=new Date()) {
      const monthOk = !entry.months?.length || entry.months.includes(monthNames[now.getMonth()]);
      const weekdayOk = (entry.days?.length || 0) > 0 ? entry.days.includes(weekdayNames[now.getDay()]) : false;
      const dom = String(now.getDate()); // "1".."31"
      const calDayOk = (entry.calendarDays?.length || 0) > 0 ? entry.calendarDays.includes(dom) : false;
      let exactDateOk = false;
      if (entry.date) exactDateOk = todayISO(now) === entry.date;

      // If user didn’t pick any day/month/date, treat as “every day”
      const scheduleOk = monthOk && (weekdayOk || calDayOk || exactDateOk || (!entry.days?.length && !entry.calendarDays?.length && !entry.date));

      const timeOk = entry.time ? compareTimeLE(entry.time, hhmm(now)) : true;
      return scheduleOk && timeOk;
    }

    function renderAllTimeSummary() {
      const all = JSON.parse(localStorage.getItem('autoRenewals')) || [];
      let addSum = 0, subSum = 0;
      all.forEach(e=>{
        const amt = Number(e.amount)||0;
        if ((e.type||'add') === 'add') addSum += amt; else subSum += amt;
      });
      const currency = localStorage.getItem('currency') || '$';
      renewalSummaryEl.textContent =
        `🔁 Scheduled (all time): ${all.length} | +${currency}${addSum.toFixed(2)} / -${currency}${subSum.toFixed(2)}`;
    }

    function runAutoRenewals(forceRenderOnly=false) {
      const all = JSON.parse(localStorage.getItem('autoRenewals')) || [];
      const today = todayISO();
      let adds=0, subs=0, countToday=0;

      // Today summary
      all.forEach(e=>{
        if (shouldRunToday(e)) {
          countToday++;
          const amt = Number(e.amount)||0;
          if ((e.type||'add') === 'add') adds += amt;
          else subs += amt;
        }
      });

      // Apply only if not just refreshing UI
      if (!forceRenderOnly) {
        all.forEach(e=>{
          if (!e.id) { e.id = 'r' + Date.now() + Math.random().toString(36).slice(2); }
          const already = appliedMap[e.id] === today;
          if (!already && shouldRunToday(e)) {
            const amt = Number(e.amount)||0;
            const ts = new Date().toLocaleString();
            if ((e.type||'add') === 'add') {
              budget += amt;
              history.push({ type:'Auto Add', value: amt, timestamp: ts });
            } else {
              budget -= amt;
              history.push({ type:'Auto Subtract', value: amt, timestamp: ts });
            }
            appliedMap[e.id] = today;
          }
        });
        localStorage.setItem('autoRenewals', JSON.stringify(all));
        localStorage.setItem('autoRenewalsApplied', JSON.stringify(appliedMap));
        localStorage.setItem('budget', budget);
        localStorage.setItem('history', JSON.stringify(history));
      }

      updateBudgetDisplay(); renderHistory(); renderAllTimeSummary();

      const currency = localStorage.getItem('currency') || '$';
      const net = (adds - subs).toFixed(2);
      renewalTodayEl.textContent = countToday
        ? `📅 Today: ${countToday} due | +${currency}${adds.toFixed(2)} / -${currency}${subs.toFixed(2)} | Net ${currency}${net}`
        : `📅 Today: none due`;

      // “Next” time hint for entries that are due later today
      const times = all
        .filter(e=>{
          if (!e.time) return false;
          // schedule matches ignoring time
          const t0 = { ...e, time: null };
          return shouldRunToday(t0, new Date(new Date().setHours(12,0,0,0)));
        })
        .map(e=>e.time)
        .filter(Boolean)
        .sort();
      const nowT = hhmm();
      const next = times.find(t => t > nowT);
      renewalNextEl.textContent = next ? `Next run at ${next}` : '';
    }

    // ===== Init =====
    updateBudgetDisplay(); renderHistory(); renderAllTimeSummary(); runAutoRenewals(true);
    // Check periodically to apply when time passes
    setInterval(runAutoRenewals, 30000);
  </script>
</body>
</html>
