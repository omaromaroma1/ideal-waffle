<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Money Budgeter</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Segoe UI,system-ui,Arial,sans-serif;padding:20px;transition:background .2s,color .2s}
  body.light-mode{background:#fff;color:#000}
  body.dark-mode{background:#121212;color:#eee}
  .calculator-box{width:360px;margin:0 auto;background:#f7f7f7;border-radius:20px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08)}
  body.dark-mode .calculator-box{background:#1e1e1e;box-shadow:0 5px 15px rgba(255,255,255,.05)}
  h1{text-align:center;margin-bottom:12px;color:#007bff}
  #clock,#budget,#renewal-summary,#renewal-next{text-align:center;margin:6px 0}
  .numpad,.buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:12px 0}
  button{flex:1 1 45%;padding:12px;border:none;border-radius:12px;font-weight:600;background:#007bff;color:#fff;cursor:pointer}
  button:hover{background:#005ed6}
  .numpad button{flex:1 1 30%;padding:14px;background:#444}
  #input-display{width:100%;text-align:right;font-size:24px;padding:10px;border:none;background:transparent;color:inherit}
  .history-header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 8px}
  .history-toggle{flex:0 0 auto;padding:6px 10px;border-radius:10px;font-size:12px;background:#e5f0ff;color:#0a3a8b;border:none}
  body.dark-mode .history-toggle{background:#243146;color:#d7e6ff}
  #history{max-height:220px;overflow:auto;background:#fff;border:1px solid #ccc;border-radius:12px;padding:10px;transition:max-height .2s}
  #history.expanded{max-height:80vh}
  body.dark-mode #history{background:#2c2c2c;border-color:#666}
  #mode-toggle{position:fixed;right:16px;bottom:16px;font-size:26px;cursor:pointer}
  /* Popups: default inert (no pointer), only active when .open */
  .popup{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
         min-width:240px;max-width:90vw;background:#fff;color:#000;border-radius:12px;
         padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);
         pointer-events:none;opacity:0;transition:opacity .15s}
  .popup.open{pointer-events:auto;opacity:1}
  body.dark-mode .popup{background:#1f2937;color:#e5e7eb}
  .popup h3{text-align:center;margin-bottom:10px}
  .popup .btn{display:block;width:100%;margin-bottom:8px;padding:10px;border:none;border-radius:10px;background:#007bff;color:#fff}
  .popup .btn:last-child{background:#aaa;color:#111}
</style>
</head>
<body>
  <div class="calculator-box">
    <h1>Money Budgeter</h1>
    <div id="clock">🕒 Time: --:--</div>
    <div id="budget">Budget: $0</div>

    <div id="renewal-summary" style="font-size:12px;opacity:.85"></div>
    <div id="renewal-next" style="font-size:12px;opacity:.85"></div>

    <input id="input-display" placeholder="Enter amount" readonly/>

    <div class="numpad">
      <button onclick="appendNumber('1')">1</button><button onclick="appendNumber('2')">2</button><button onclick="appendNumber('3')">3</button>
      <button onclick="appendNumber('4')">4</button><button onclick="appendNumber('5')">5</button><button onclick="appendNumber('6')">6</button>
      <button onclick="appendNumber('7')">7</button><button onclick="appendNumber('8')">8</button><button onclick="appendNumber('9')">9</button>
      <button onclick="appendNumber('0')">0</button><button onclick="appendNumber('.')">.</button><button onclick="backspace()">⌫</button>
    </div>

    <div class="buttons">
      <button onclick="submitAmount('add')">Add</button>
      <button onclick="openSubtract()">Subtract</button>
      <button onclick="clearHistory()">Clear History</button>
      <button onclick="resetBudget()">Reset</button>
      <button onclick="location.href='repeat.html'">Repeat ➕</button>
      <button onclick="viewCategoryTotals()">📊 View Categories</button>
      <button onclick="runAutoRenewals(true)">↻ Refresh Renewals</button>
    </div>

    <div class="history-header">
      <div style="font-weight:600">History</div>
      <button id="toggleHistoryBtn" class="history-toggle">Expand ⇵</button>
    </div>
    <div id="history"></div>
  </div>

  <div id="mode-toggle" onclick="toggleMode()">🌙</div>

  <!-- popups -->
  <div id="category-popup" class="popup" aria-hidden="true"></div>
  <div id="totals-popup" class="popup" aria-hidden="true"></div>

<script>
  // ===== State =====
  const budgetEl = document.getElementById('budget');
  const historyEl = document.getElementById('history');
  const inputEl = document.getElementById('input-display');
  const catPopup = document.getElementById('category-popup');
  const totalsPopup = document.getElementById('totals-popup');
  const renewalSummaryEl = document.getElementById('renewal-summary');
  const renewalNextEl = document.getElementById('renewal-next');

  let budget = parseFloat(localStorage.getItem('budget')) || 0;
  let history = JSON.parse(localStorage.getItem('history')) || [];
  let appliedMap = JSON.parse(localStorage.getItem('autoRenewalsApplied')) || {};
  const categories = ['Leisure','Transportation','Food','Groceries','Others','Games','Friends'];
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const weekdays = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

  // ===== Theme =====
  (localStorage.getItem('theme')==='dark'?document.body.classList.add('dark-mode'):document.body.classList.add('light-mode'));
  function toggleMode(){
    const dark=document.body.classList.contains('dark-mode');
    document.body.classList.toggle('dark-mode',!dark);
    document.body.classList.toggle('light-mode',dark);
    localStorage.setItem('theme',dark?'light':'dark');
  }

  // ===== Clock =====
  function tickClock(){
    const n=new Date();
    document.getElementById('clock').textContent='🕒 Time: '+
      n.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:true});
  }
  setInterval(tickClock,1000); tickClock();

  // ===== Calculator =====
  function appendNumber(n){ inputEl.value+=n; }
  function backspace(){ inputEl.value=inputEl.value.slice(0,-1); }
  function clearInput(){ inputEl.value=''; }

  function submitAmount(type){
    const v=parseFloat(inputEl.value);
    if(isNaN(v)) return;
    const ts=new Date().toLocaleString();
    if(type==='add'){ budget+=v; history.push({type:'Add',value:v,timestamp:ts}); }
    saveBudget(); renderHistory(); clearInput();
  }

  function openSubtract(){
    catPopup.innerHTML = '<h3>Select Category</h3>' +
      categories.map(c=>`<button class="btn" onclick="doSubtract('${c}')">${c}</button>`).join('') +
      `<button class="btn" onclick="closePopup('category')">Close</button>`;
    openPopup('category');
  }
  function doSubtract(cat){
    const v=parseFloat(inputEl.value);
    closePopup('category'); clearInput();
    if(isNaN(v)) return;
    const ts=new Date().toLocaleString();
    budget-=v; history.push({type:`Subtract (${cat})`,value:v,timestamp:ts});
    saveBudget(); renderHistory();
  }

  function clearHistory(){ history=[]; localStorage.setItem('history','[]'); renderHistory(); }
  function resetBudget(){ budget=0; saveBudget(); }

  function saveBudget(){
    localStorage.setItem('budget',budget);
    localStorage.setItem('history',JSON.stringify(history));
    updateBudget();
  }
  function updateBudget(){
    const cur=localStorage.getItem('currency')||'$';
    budgetEl.textContent=`Budget: ${cur}${budget.toFixed(2)}`;
  }
  function renderHistory(){
    historyEl.innerHTML='';
    history.slice().reverse().forEach(it=>{
      const d=document.createElement('div');
      d.textContent = `${it.timestamp} — ${it.type}: $${it.value.toFixed(2)}`;
      historyEl.appendChild(d);
    });
  }

  // ===== Popups (no overlay, no block unless open) =====
  function openPopup(which){
    const el = which==='category'?catPopup:totalsPopup;
    el.classList.add('open');
    el.setAttribute('aria-hidden','false');
  }
  function closePopup(which){
    const el = which==='category'?catPopup:totalsPopup;
    el.classList.remove('open');
    el.setAttribute('aria-hidden','true');
  }
  // Hard-close any stuck popup on load
  closePopup('category'); closePopup('totals');

  function viewCategoryTotals(){
    const totals = Object.fromEntries(categories.map(c=>[c,0]));
    history.forEach(h=>{
      const m=h.type.match(/^Subtract \((.+)\)$/);
      if(m && totals[m[1]]!==undefined) totals[m[1]]+=h.value;
    });
    const cur=localStorage.getItem('currency')||'$';
    totalsPopup.innerHTML = '<h3>Category Totals</h3>' +
      categories.map(c=>`<button class="btn" disabled>${c}: ${cur}${totals[c].toFixed(2)}</button>`).join('') +
      `<button class="btn" onclick="closePopup('totals')">Close</button>`;
    openPopup('totals');
  }

  // ===== History expand =====
  document.getElementById('toggleHistoryBtn').addEventListener('click',()=>{
    const exp=historyEl.classList.toggle('expanded');
    document.getElementById('toggleHistoryBtn').textContent = exp?'Collapse ⇵':'Expand ⇵';
  });

  // ===== Auto-renew (unchanged logic, no “today” line) =====
  function todayISO(d=new Date()){ return d.toISOString().slice(0,10); }
  function hhmm(d=new Date()){ return d.toTimeString().slice(0,5); }
  function shouldRunToday(e,now=new Date()){
    const monthOk = !e.months?.length || e.months.includes(months[now.getMonth()]);
    const weekdayOk = (e.days?.length||0)>0 ? e.days.includes(weekdays[now.getDay()]) : false;
    const dom=String(now.getDate());
    const domOk=(e.calendarDays?.length||0)>0 ? e.calendarDays.includes(dom) : false;
    const exact = e.date ? (todayISO(now)===e.date) : false;
    const scheduleOk = monthOk && (weekdayOk || domOk || exact || (!e.days?.length && !e.calendarDays?.length && !e.date));
    const timeOk = e.time ? (e.time <= hhmm(now)) : true;
    return scheduleOk && timeOk;
  }
  function renderAllTimeSummary(){
    const all=JSON.parse(localStorage.getItem('autoRenewals'))||[];
    let add=0, sub=0;
    all.forEach(e=>{ const a=+e.amount||0; (e.type||'add')==='add'? add+=a : sub+=a; });
    const cur=localStorage.getItem('currency')||'$';
    renewalSummaryEl.textContent = `🔁 Scheduled (all time): ${all.length} | +${cur}${add.toFixed(2)} / -${cur}${sub.toFixed(2)}`;
    // Next time hint (first future time today)
    const times = all.map(e=>e.time).filter(Boolean).sort();
    const next = times.find(t=>t>hhmm());
    renewalNextEl.textContent = next? `Next run at ${next}` : '';
  }
  function runAutoRenewals(renderOnly=false){
    const all=JSON.parse(localStorage.getItem('autoRenewals'))||[];
    const today=todayISO();
    if(!renderOnly){
      all.forEach(e=>{
        if(!e.id) e.id='r'+Date.now()+Math.random().toString(36).slice(2);
        const already = appliedMap[e.id]===today;
        if(!already && shouldRunToday(e)){
          const amt=+e.amount||0, ts=new Date().toLocaleString();
          if((e.type||'add')==='add'){ budget+=amt; history.push({type:'Auto Add',value:amt,timestamp:ts}); }
          else{ budget-=amt; history.push({type:'Auto Subtract',value:amt,timestamp:ts}); }
          appliedMap[e.id]=today;
        }
      });
      localStorage.setItem('autoRenewals',JSON.stringify(all));
      localStorage.setItem('autoRenewalsApplied',JSON.stringify(appliedMap));
      saveBudget();
    }
    renderAllTimeSummary();
  }

  // ===== Init =====
  updateBudget(); renderHistory(); runAutoRenewals(true);
  setInterval(runAutoRenewals,30000);
</script>
</body>
</html>
